// soundManager.js - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô GTMS
const fs = require('fs');
const path = require('path');

// üéµ ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
const SOUND_CONFIG = {
    // ‡πÑ‡∏î‡πÄ‡∏£‡∏Å‡∏ó‡∏≠‡∏£‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    BASE_SOUND_DIR: path.join(__dirname, 'assets', 'sounds'),
    
    // ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    SUPPORTED_LANGUAGES: ['th', 'en'],
    
    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    SOUND_TYPES: {
        medication: {
            files: {
                th: 'medication.mp3',
                en: 'medication.mp3',
                beep: 'soft-beep.mp3'
            },
            description: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏≤ - ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•',
            volume: 0.7,
            priority: 'medium',
            vibration: [200, 100, 200]
        },
        appointment: {
            files: {
                th: 'appointment.mp3', 
                en: 'appointment.mp3',
                beep: 'clear-beep.mp3'
            },
            description: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ - ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô',
            volume: 0.8,
            priority: 'high',
            vibration: [300, 200, 300]
        },
        emergency: {
            files: {
                th: 'emergency.mp3',
                en: 'emergency.mp3', 
                beep: 'urgent-beep.mp3'
            },
            description: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô - ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô',
            volume: 1.0,
            priority: 'urgent',
            vibration: [500, 100, 500, 100, 500]
        },
        general: {
            files: {
                th: 'general.mp3',
                en: 'general.mp3',
                beep: 'general-beep.mp3'
            },
            description: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô',
            volume: 0.6,
            priority: 'low',
            vibration: [150, 100, 150]
        },
        iop_warning: {
            files: {
                th: 'iop-warning.mp3',
                en: 'iop-warning.mp3',
                beep: 'warning-beep.mp3'
            },
            description: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô IOP ‡∏™‡∏π‡∏á - ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
            volume: 0.9,
            priority: 'high',
            vibration: [400, 150, 400]
        }
    }
};

// üó£Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Text-to-Speech (‡∏™‡∏≥‡∏£‡∏≠‡∏á)
const SPEECH_MESSAGES = {
    medication: {
        th: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏¢‡∏≠‡∏î‡∏¢‡∏≤‡∏ï‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏¢‡∏≠‡∏î‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á',
        en: 'Time for your eye drops medication'
    },
    appointment: {
        th: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•',
        en: 'You have an appointment with your doctor'
    },
    emergency: {
        th: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
        en: 'Please check your eye pressure and contact your doctor immediately'
    },
    general: {
        th: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
        en: 'You have a new notification'
    },
    iop_warning: {
        th: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå',
        en: 'Your eye pressure is higher than normal. Please rest and contact your doctor'
    }
};

class SoundManager {
    constructor() {
        this.config = SOUND_CONFIG;
        this.speechMessages = SPEECH_MESSAGES;
        this.initializeSoundDirectories();
    }

    // üìÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    initializeSoundDirectories() {
        try {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å
            if (!fs.existsSync(this.config.BASE_SOUND_DIR)) {
                fs.mkdirSync(this.config.BASE_SOUND_DIR, { recursive: true });
                console.log(`üìÅ Created main sound directory: ${this.config.BASE_SOUND_DIR}`);
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏¢‡πà‡∏≠‡∏¢
            const subDirs = ['th', 'en', 'beeps'];
            subDirs.forEach(dir => {
                const fullPath = path.join(this.config.BASE_SOUND_DIR, dir);
                if (!fs.existsSync(fullPath)) {
                    fs.mkdirSync(fullPath, { recursive: true });
                    console.log(`üìÅ Created directory: ${fullPath}`);
                }
            });

            console.log('‚úÖ Sound directories initialized successfully');
        } catch (error) {
            console.error('‚ùå Error creating sound directories:', error);
        }
    }

    // üéµ ‡∏£‡∏±‡∏ö URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    getSoundUrl(type, language = 'th', fallback = 'beep') {
        try {
            const soundType = this.config.SOUND_TYPES[type];
            if (!soundType) {
                console.warn(`‚ö†Ô∏è Unknown sound type: ${type}`);
                return this.getSoundUrl('general', language, fallback);
            }

            // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
            if (soundType.files[language]) {
                const filename = soundType.files[language];
                const fullPath = path.join(this.config.BASE_SOUND_DIR, language, filename);
                
                if (fs.existsSync(fullPath)) {
                    return `/api/sounds/${language}/${filename}`;
                }
            }

            // ‡πÉ‡∏ä‡πâ fallback
            if (fallback && soundType.files[fallback]) {
                const filename = soundType.files[fallback];
                const fallbackDir = fallback === 'beep' ? 'beeps' : fallback;
                const fullPath = path.join(this.config.BASE_SOUND_DIR, fallbackDir, filename);
                
                if (fs.existsSync(fullPath)) {
                    return `/api/sounds/${fallbackDir}/${filename}`;
                }
            }

            console.warn(`‚ö†Ô∏è No sound file found for type: ${type}, language: ${language}`);
            return null;
        } catch (error) {
            console.error(`‚ùå Error getting sound URL for ${type}:`, error);
            return null;
        }
    }

    // üîä ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
    getSoundConfig(type, language = 'th') {
        const soundType = this.config.SOUND_TYPES[type];
        if (!soundType) {
            return null;
        }

        return {
            type: type,
            url: this.getSoundUrl(type, language),
            volume: soundType.volume,
            priority: soundType.priority,
            vibration: soundType.vibration,
            description: soundType.description,
            speechText: this.speechMessages[type] ? this.speechMessages[type][language] : null
        };
    }

    // üì± ‡∏£‡∏±‡∏ö vibration pattern
    getVibrationPattern(type) {
        const soundType = this.config.SOUND_TYPES[type];
        return soundType ? soundType.vibration : [200, 100, 200];
    }

    // üó£Ô∏è ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Text-to-Speech
    getSpeechText(type, language = 'th') {
        if (this.speechMessages[type] && this.speechMessages[type][language]) {
            return this.speechMessages[type][language];
        }
        return null;
    }

    // üìã ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    getAllSoundTypes() {
        return Object.keys(this.config.SOUND_TYPES).map(type => ({
            type: type,
            config: this.getSoundConfig(type),
            ...this.config.SOUND_TYPES[type]
        }));
    }

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
    checkSoundFile(type, language = 'th') {
        try {
            const soundType = this.config.SOUND_TYPES[type];
            if (!soundType || !soundType.files[language]) {
                return false;
            }

            const filename = soundType.files[language];
            const dir = language === 'beep' ? 'beeps' : language;
            const fullPath = path.join(this.config.BASE_SOUND_DIR, dir, filename);
            
            return fs.existsSync(fullPath);
        } catch (error) {
            console.error(`Error checking sound file: ${error}`);
            return false;
        }
    }

    // üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    getSoundStatus() {
        const status = {
            totalTypes: Object.keys(this.config.SOUND_TYPES).length,
            missingFiles: [],
            availableFiles: [],
            summary: {}
        };

        Object.keys(this.config.SOUND_TYPES).forEach(type => {
            status.summary[type] = {};
            
            ['th', 'en', 'beep'].forEach(lang => {
                const exists = this.checkSoundFile(type, lang);
                status.summary[type][lang] = exists;
                
                if (exists) {
                    status.availableFiles.push(`${type}-${lang}`);
                } else {
                    status.missingFiles.push(`${type}-${lang}`);
                }
            });
        });

        return status;
    }

    // üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    setVolume(type, volume) {
        if (this.config.SOUND_TYPES[type]) {
            this.config.SOUND_TYPES[type].volume = Math.max(0, Math.min(1, volume));
            return true;
        }
        return false;
    }

    // üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    saveConfig() {
        try {
            const configPath = path.join(__dirname, 'sound-config.json');
            fs.writeFileSync(configPath, JSON.stringify(this.config, null, 2));
            console.log('‚úÖ Sound configuration saved');
            return true;
        } catch (error) {
            console.error('‚ùå Error saving sound configuration:', error);
            return false;
        }
    }

    // üìñ ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    loadConfig() {
        try {
            const configPath = path.join(__dirname, 'sound-config.json');
            if (fs.existsSync(configPath)) {
                const savedConfig = JSON.parse(fs.readFileSync(configPath, 'utf8'));
                this.config = { ...this.config, ...savedConfig };
                console.log('‚úÖ Sound configuration loaded');
                return true;
            }
        } catch (error) {
            console.error('‚ùå Error loading sound configuration:', error);
        }
        return false;
    }
}

// üéµ ‡∏™‡∏£‡πâ‡∏≤‡∏á instance ‡πÅ‡∏•‡∏∞ export
const soundManager = new SoundManager();

// üì§ Export functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Express
module.exports = {
    soundManager,
    
    // Middleware ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö serve ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    serveSoundFile: (req, res) => {
        try {
            const { lang, filename } = req.params;
            
            // Security check
            const allowedLangs = ['th', 'en', 'beeps'];
            const allowedExtensions = ['.mp3', '.wav', '.ogg'];
            
            if (!allowedLangs.includes(lang)) {
                return res.status(400).json({ error: 'Invalid language' });
            }
            
            const ext = path.extname(filename).toLowerCase();
            if (!allowedExtensions.includes(ext)) {
                return res.status(400).json({ error: 'Invalid file type' });
            }
            
            const filePath = path.join(soundManager.config.BASE_SOUND_DIR, lang, filename);
            
            if (fs.existsSync(filePath)) {
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ headers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                res.setHeader('Content-Type', 'audio/mpeg');
                res.setHeader('Cache-Control', 'public, max-age=86400'); // Cache 1 ‡∏ß‡∏±‡∏ô
                res.setHeader('Accept-Ranges', 'bytes');
                
                res.sendFile(filePath);
            } else {
                res.status(404).json({ error: 'Sound file not found' });
            }
        } catch (error) {
            console.error('Error serving sound file:', error);
            res.status(500).json({ error: 'Internal server error' });
        }
    },
    
    // API endpoints
    getSoundConfig: (type, language) => soundManager.getSoundConfig(type, language),
    getAllSoundTypes: () => soundManager.getAllSoundTypes(),
    getSoundStatus: () => soundManager.getSoundStatus(),
    getVibrationPattern: (type) => soundManager.getVibrationPattern(type),
    getSpeechText: (type, language) => soundManager.getSpeechText(type, language)
};

console.log('üéµ Sound Manager initialized');
console.log('üìÅ Base sound directory:', soundManager.config.BASE_SOUND_DIR);
console.log('üîä Available sound types:', Object.keys(soundManager.config.SOUND_TYPES));